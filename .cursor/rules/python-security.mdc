---
description: Security best practices for Python code including input validation and credential management
globs: ["**/cli/**/*", "**/api/**/*", "**/*security*.py", "**/*auth*.py", "**/*credentials*.py"]
alwaysApply: false
---

# Python Security Standards

## Core Principles

- Never hardcode secrets - use environment variables
- Validate all external inputs
- Use parameterized queries (never string interpolation)
- Build subprocess commands as lists, not strings
- Don't expose sensitive info in errors

## Secrets Management

```python
# ✅ Good - Pydantic Settings with SecretStr
from pydantic import SecretStr, Field
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    plaid_client_id: str
    plaid_secret: SecretStr  # Use SecretStr for passwords/keys

# ❌ Bad - hardcoded
API_KEY = "sk_live_abc123"
```

## Input Validation

```python
# Path validation - prevent traversal
if ".." in file_path or path.is_absolute():
    raise ValueError("Invalid path")

# String validation - prevent injection
if any(char in input_str for char in [';', '|', '&', '$', '`']):
    raise ValueError("Invalid characters")
```

## SQL Injection Prevention

```python
# ✅ Good - parameterized query
query = "SELECT * FROM transactions WHERE account_id = ?"
result = conn.execute(query, [account_id]).fetchdf()

# ❌ Bad - string interpolation
query = f"SELECT * FROM transactions WHERE account_id = '{account_id}'"  # VULNERABLE
```

## Command Injection Prevention

```python
# ✅ Good - list format
cmd = ["dbt", "run", "--project-dir", validated_dir, "--models", models]
subprocess.run(cmd, check=False)  # Never shell=True with user input

# ❌ Bad - string with shell=True
cmd = f"dbt run --models {models}"
subprocess.run(cmd, shell=True)  # VULNERABLE
```

## Error Handling

```python
# Log detailed errors internally, return generic errors to users
try:
    result = sensitive_operation()
except Exception as e:
    logger.exception(f"Error for account {account_id}")  # Detailed internal log
    raise RuntimeError("An error occurred")  # Generic user message
```
