---
description: DuckDB function usage and SQL patterns
globs: ["**/*.sql", "dbt/**/*.sql", "pipelines/**/*.py", "src/**/loaders/**/*.py"]
alwaysApply: false
---

# DuckDB Function Usage Standards

## CSV Operations

```sql
-- Read CSV
SELECT * FROM read_csv('file.csv', auto_detect=true)

-- Write CSV/Parquet
COPY (SELECT * FROM transactions) TO 'output.csv' (HEADER, DELIMITER ',')
COPY transactions TO 'data.parquet' (FORMAT PARQUET)
```

## Date/Time Functions

```sql
-- Parsing: strptime(date_string, '%Y-%m-%d')
-- Formatting: strftime(date_col, '%Y-%m')
-- Extract: YEAR(date_col), MONTH(date_col), DAY(date_col)
-- Truncate: date_trunc('month', date_col)
-- Range: date_col BETWEEN '2023-01-01' AND '2023-12-31'
```

## Aggregations

```sql
-- Basic: SUM(amount), AVG(amount), COUNT(*)
-- Round currency: ROUND(amount, 2)
-- Running total: SUM(amount) OVER (ORDER BY date ROWS UNBOUNDED PRECEDING)
-- Previous period: LAG(amount, 1) OVER (PARTITION BY account ORDER BY date)
```

## String Functions

```sql
-- Pattern match: regexp_matches(description, 'PATTERN')
-- Simple match: description LIKE '%MERCHANT%'
-- Case insensitive: UPPER(description), LOWER(description)
```

## Performance

- Create indexes: `CREATE INDEX idx_date ON transactions(date)`
- Filter early: Apply WHERE before JOINs
- Use proper types: `DECIMAL(10,2)` for currency, `DATE` for dates
- Batch inserts: `INSERT INTO ... SELECT`

## Python Integration

```python
import duckdb

with duckdb.connect('financial.db') as conn:
    result = conn.execute("SELECT * FROM transactions WHERE date >= ?", [start_date]).fetchdf()
```

## Anti-Patterns

❌ Don't use MySQL/PostgreSQL-specific syntax
❌ Don't use LIMIT without ORDER BY (non-deterministic)
❌ Don't use FLOAT for currency (use DECIMAL)
❌ Don't concatenate SQL strings (use parameterized queries)

See [DuckDB docs](https://duckdb.org/docs/) for complete reference
